"""
Configuration base de donnÃ©es MariaDB
"""
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker, Session
from sqlalchemy.ext.declarative import declarative_base
import os
import logging

logger = logging.getLogger(__name__)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION MARIADB (depuis Container Docker)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MARIADB_USER = os.getenv("MARIADB_USER", "ejbca")
MARIADB_PASSWORD = os.getenv("MARIADB_PASSWORD", "ejbca")
MARIADB_HOST = os.getenv("MARIADB_HOST", "mariadb")  # Hostname du container Docker
MARIADB_PORT = os.getenv("MARIADB_PORT", "3306")
MARIADB_DATABASE = os.getenv("MARIADB_DATABASE", "ejbca")

# URL de connexion Ã  MariaDB (container Docker)
DATABASE_URL = f"mysql+pymysql://{MARIADB_USER}:{MARIADB_PASSWORD}@{MARIADB_HOST}:{MARIADB_PORT}/{MARIADB_DATABASE}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOGS DE CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

logger.info("ğŸ“Š Configuration MariaDB (Container Docker):")
logger.info(f"   Host: {MARIADB_HOST}:{MARIADB_PORT}")
logger.info(f"   Database: {MARIADB_DATABASE}")
logger.info(f"   User: {MARIADB_USER}")
logger.info(f"   URL: mysql+pymysql://***:***@{MARIADB_HOST}:{MARIADB_PORT}/{MARIADB_DATABASE}")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENGINE SQLALCHEMY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

engine = create_engine(
    DATABASE_URL,
    echo=False,
    pool_pre_ping=True,  # VÃ©rifier la connexion avant chaque utilisation
    pool_recycle=3600,  # Recycler les connexions aprÃ¨s 1 heure
    pool_size=10,
    max_overflow=20
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SESSION FACTORY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BASE DECLARATIVE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Base = declarative_base()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DÃ‰PENDANCE FASTAPI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_db() -> Session:
    """Obtenir une session DB pour les endpoints FastAPI"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INITIALISATION DES TABLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def create_tables():
    """CrÃ©er les tables dans la DB"""
    try:
        Base.metadata.create_all(bind=engine)
        logger.info("âœ… Tables crÃ©Ã©es/vÃ©rifiÃ©es dans MariaDB")
    except Exception as e:
        logger.error(f"âŒ Erreur crÃ©ation tables: {e}")
        raise

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEST DE CONNEXION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_connection() -> bool:
    """Tester la connexion Ã  MariaDB"""
    try:
        with engine.connect() as conn:
            result = conn.execute(text("SELECT 1 AS test"))
            logger.info("âœ… Connexion MariaDB rÃ©ussie")
            return True
    except Exception as e:
        logger.error(f"âŒ Impossible de se connecter Ã  MariaDB: {e}")
        logger.error(f"   Assurez-vous que le container MariaDB est en cours d'exÃ©cution")
        return False

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INITIALISATION ASYNCHRONE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def init_db():
    """Initialiser la base de donnÃ©es au dÃ©marrage"""
    try:
        # VÃ©rifier la connexion
        if not test_connection():
            raise Exception("Impossible de se connecter Ã  MariaDB")
        
        # CrÃ©er les tables
        create_tables()
        logger.info("âœ… Base de donnÃ©es MariaDB initialisÃ©e avec succÃ¨s")
    except Exception as e:
        logger.error(f"âŒ Erreur initialisation DB: {e}")
        raise
